/*!
 * Copyright 2021, Halil Ibrahim Ercelik
 * Released under the MIT License
 * {@link https://github.com/halillusion/vpjax GitHub}
 * Inspired by defunkt's jQuery-Pjax
 */
class vPjax{constructor(t,e=null){return this.version="0.7.0",this.options={selector:null,wrap:null,formSelector:null,url:null,cacheExpire:300,timeOut:1e3},null!==e&&(this.options.wrap=e),"object"!=typeof t?(this.options.selector=t,null===e&&console.error("Wrapper is not defined!")):this.mergeObject(this.options,t),this.fetch=null,this.method="GET",this.formData=null,window.onpopstate=(t=>this.getBack(t)),this}init(){let t=document.querySelectorAll(this.options.selector);for(let e=0;e<t.length;e++)t[e].addEventListener("click",o=>{this.handler(o,t[e])});if(this.options.formSelector){let t=document.querySelectorAll(this.options.formSelector);for(let e=0;e<t.length;e++)t[e].addEventListener("submit",o=>{this.formHandler(o,t[e])})}return this}mergeObject(t,e,o=null){if(null!==t&&null!==e){const o=Object.keys(e);let n=null;for(let i=0;i<o.length;i++)n=o[i],t.hasOwnProperty(n)&&"object"==typeof e[n]?t[n]=this.mergeObject(t[n],e[n],n):t[n]=e[n]}else t=e;return t}handler(t,e){if("#"===e.getAttribute("href"))return;let o=this.urlCheck(e.getAttribute("href"));if(!1===o)return;const n=new URL(o);if(t.ctrlKey||t.shiftKey||t.altKey||t.metaKey||t.which>1)return;if(location.protocol!==n.protocol||location.hostname!==n.hostname)return void(location.href=n);if(n.href.indexOf("#")>-1&&this.stripHash(n)===this.stripHash(location))return;const i=new CustomEvent("vPjax:click",{detail:{options:this.options}});return document.dispatchEvent(i),this.formData=null,this.method="GET",this.get(n),t.preventDefault(),this}urlCheck(t){let e=new RegExp("^(https?:\\/\\/)?((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|((\\d{1,3}\\.){3}\\d{1,3}))(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*(\\?[;&a-z\\d%_.~+=-]*)?(\\#[-a-z\\d_]*)?$","i");return e.test(t)?t:(t=window.location.origin+t,!!e.test(t)&&t)}reload(t=null){this.method="GET",this.formData=null,null===t&&(t=location.href),this.get(t)}formHandler(t,e){if("#"===e.getAttribute("action"))return;let o=e.getAttribute("action");if(-1===o.indexOf(location.origin)&&(o=location.origin+("/"===o.substring(0,1)?"":"/")+o),this.formData=new FormData(e),"GET"===e.getAttribute("method").toUpperCase())return;this.method="POST";const n=new CustomEvent("vPjax:submit",{detail:{options:this.options}});return document.dispatchEvent(n),this.get(o),t.preventDefault(),this}async get(t){const e=new CustomEvent("vPjax:beforeSend",{detail:{options:this.options,url:t}});document.dispatchEvent(e);const o=new AbortController;let n;this.options.url=t,this.options.timeOut&&(n=setTimeout(()=>{if(!this.fetch){const t=new CustomEvent("vPjax:timeout",{detail:{options:this.options,fetch:o}});document.dispatchEvent(t),o.abort(),location.href=this.options.url,clearTimeout(n)}},this.options.timeOut));const i=new CustomEvent("vPjax:start",{detail:{options:this.options,abort:o}});document.dispatchEvent(i);let s={method:this.method,mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"X-VPJAX":!0},redirect:"follow",referrerPolicy:"same-origin",signal:o.signal};return this.formData&&(s.body=this.formData),this.fetch=await fetch(this.options.url,s).then(function(t){return!!t.ok&&t.text()}).then(function(t){const e=new CustomEvent("vPjax:success",{detail:{dom:t}});return document.dispatchEvent(e),t}).catch(function(t){const e=new CustomEvent("vPjax:error",{detail:{error:t}});throw document.dispatchEvent(e),t}),this.fetch&&(this.loadContent(this.fetch),this.options.timeOut&&clearTimeout(n),this.fetch=null),this}loadContent(t,e=!1){let o=(new DOMParser).parseFromString(t,"text/html"),n=o.querySelector(this.options.wrap);if(!n)throw location.href=this.options.url,"Server response is not correct! -> "+t;{let t=document.querySelector(this.options.wrap);if(!t)throw location.href=this.options.url,"The element specified as selector does not exist!";{const i=new CustomEvent("vPjax:beforeExtract",{detail:{options:this.options,dom:o}});document.dispatchEvent(i);let s=n.innerHTML,r=document.querySelector("title").textContent;t.innerHTML=s,(r=o.querySelector("title").textContent)&&(document.querySelector("title").textContent=r);let l=new URL(this.options.url);e?window.history.back(-1):window.history.pushState({},"",l);const h=new CustomEvent("vPjax:finish",{detail:{options:this.options,url:l}});document.dispatchEvent(h),this.init()}}return this}stripHash(t){return t.href.replace(/#.*/,"")}form(t){return this.options.formSelector=t,this}getBack(t){const e=new CustomEvent("vPjax:popstate",{detail:{options:this.options,url:document.location}});document.dispatchEvent(e),this.get(document.location)}}