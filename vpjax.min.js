/*!
 * Copyright 2021, Halil Ibrahim Ercelik
 * Released under the MIT License
 * {@link https://github.com/halillusion/vpjax GitHub}
 * Inspired by defunkt's jQuery-Pjax
 */
class vPjax{constructor(t,e){return this.version="0.2.0",this.options={selector:t,wrap:e,formSelector:null,url:null,cacheExpire:300,timeOut:1e3},this.fetch=null,this.method="GET",this.formData=null,window.onpopstate=(t=>this.getBack(t)),this}init(){let t=document.querySelectorAll(this.options.selector);for(let e=0;e<t.length;e++)t[e].addEventListener("click",o=>{this.handler(o,t[e])});if(this.options.formSelector){let t=document.querySelectorAll(this.options.formSelector);for(let e=0;e<t.length;e++)t[e].addEventListener("submit",o=>{this.formHandler(o,t[e])})}return this}handler(t,e){if("#"===e.getAttribute("href"))return;const o=new URL(e.getAttribute("href"));if(t.ctrlKey||t.shiftKey||t.altKey||t.metaKey||t.which>1)return;if(location.protocol!==o.protocol||location.hostname!==o.hostname)return void(location.href=o);if(o.href.indexOf("#")>-1&&this.stripHash(o)===this.stripHash(location))return;const i=new CustomEvent("vPjax:click",{detail:{options:this.options}});return document.dispatchEvent(i),this.formData=null,this.method="GET",this.get(o),t.preventDefault(),this}reload(){this.method="GET",this.formData=null,this.get(location.href)}formHandler(t,e){if("#"===e.getAttribute("action"))return;let o=e.getAttribute("action");if(-1===o.indexOf(location.origin)&&(o=location.origin+("/"===o.substring(0,1)?"":"/")+o),this.formData=new FormData(e),"GET"===e.getAttribute("method").toUpperCase())return;this.method="POST";const i=new CustomEvent("vPjax:submit",{detail:{options:this.options}});return document.dispatchEvent(i),this.get(o),t.preventDefault(),this}async get(t){const e=new CustomEvent("vPjax:beforeSend",{detail:{options:this.options,url:t}});document.dispatchEvent(e);const o=new AbortController;let i;this.options.url=t,this.options.timeOut&&(i=setTimeout(()=>{if(!this.fetch){const t=new CustomEvent("vPjax:timeout",{detail:{options:this.options,fetch:o}});document.dispatchEvent(t),o.abort(),location.href=this.options.url,clearTimeout(i)}},this.options.timeOut));const n=new CustomEvent("vPjax:start",{detail:{options:this.options,abort:o}});document.dispatchEvent(n);let s={method:this.method,mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"X-VPJAX":!0},redirect:"follow",referrerPolicy:"same-origin",signal:o.signal};return this.formData&&(s.body=this.formData),this.fetch=await fetch(this.options.url,s).then(function(t){return!!t.ok&&t.text()}).then(function(t){const e=new CustomEvent("vPjax:success",{detail:{dom:t}});return document.dispatchEvent(e),t}).catch(function(t){const e=new CustomEvent("vPjax:error",{detail:{error:t}});throw document.dispatchEvent(e),t}),this.fetch&&(this.loadContent(this.fetch),this.options.timeOut&&clearTimeout(i),this.fetch=null),this}loadContent(t,e=!1){let o=(new DOMParser).parseFromString(t,"text/html"),i=o.querySelector(this.options.wrap);if(!i)throw location.href=this.options.url,"Server response is not correct! -> "+t;{let t=document.querySelector(this.options.wrap);if(!t)throw location.href=this.options.url,"The element specified as selector does not exist!";{const n=new CustomEvent("vPjax:beforeExtract",{detail:{options:this.options,dom:o}});document.dispatchEvent(n);let s=i.innerHTML,r=document.querySelector("title").textContent;t.innerHTML=s,(r=o.querySelector("title").textContent)&&(document.querySelector("title").textContent=r);let h=new URL(this.options.url);e?window.history.back(-1):window.history.pushState({},"",h);const c=new CustomEvent("vPjax:finish",{detail:{options:this.options,url:h}});document.dispatchEvent(c),this.init()}}return this}stripHash(t){return t.href.replace(/#.*/,"")}form(t){return this.options.formSelector=t,this}getBack(t){const e=new CustomEvent("vPjax:popstate",{detail:{options:this.options,url:document.location}});return document.dispatchEvent(e),this.get(document.location),this}}
